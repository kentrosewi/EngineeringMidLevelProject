<!DOCTYPE html>
<html lang="en">
<head>
	<title>Feature Request</title>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.1.0/css/bootstrap.min.css">
	<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.0/umd/popper.min.js"></script>
	<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.1.0/js/bootstrap.min.js"></script>
	<script type='text/javascript' src='http://ajax.aspnetcdn.com/ajax/knockout/knockout-3.4.2.js'></script>
</head>
<body> 
<div class="alert alert-success" id="success-alert">
    <strong>Success! </strong>
    Your action has completed successfully.
</div>
<div class="alert alert-danger" id="danger-alert">
    <strong>Error! </strong>
    Please try again in a short while.
</div>

<div class="container-fluid"> 
	<div class="row mb-4">
		<div class="col-md-12" style="text-align: center;">
			<h1>Feature Request</h1>		
		</div>
	</div>
	
	<form data-bind="submit: getClientFeatureRequests" class="mb-4">
		<div class="row">
			<div class="col-md-5 mb-2">
				<select required class="form-control" data-bind="options: clients,
																	optionsText: 'name',
																	optionsValue: 'id',
																	value: clientIdSelected,
																	optionsCaption: 'Select a Client'">
				</select>
			</div>
			<div class="col-md-5 mb-2">
				<select class="form-control" data-bind="options: productAreas,
																	optionsText: 'name',
																	optionsValue: 'id',
																	value: productAreaIdSelected,
																	optionsCaption: 'Select a Product Area [Optional]'">
				</select>
			</div>
			<div class="col-md-2 mb-2">
				<button type="submit" class="btn btn-success" style="width: 100%">Go</button>
			</div>		
		</div>
	</form>

	<div class="row mb-4">
		<div class="col-md-6 offset-md-3">
			<div class="card">
				<div class="card-header">
					<div class="row">
						<div class="col-md-12">
							<button type="button" style="width: 100%" class="btn btn-info" data-toggle="collapse" data-target="#submitBlock">Enter a new feature request</button>						
						</div>
					</div>					
				</div>
				<div id="submitBlock" class="collapse">
					<div class="card-block">
						<div class="row">
							<div class="offset-md-1 col-md-10">
								<form id="submitForm" data-bind="submit: submitNewFeatureRequest">
									<div class="form-group ml-2 mr-2 mt-2">
										<label for="clientInput">Client</label>
										<select required id="clientInput" class="form-control" data-bind="options: clients,
																							optionsText: 'name',
																							optionsValue: 'id',
																							value: newClientId,
																							optionsCaption: 'Select a Client'">
										</select>
									</div>									
									<div class="form-group ml-2 mr-2">
										<label for="productAreaInput">Product Area</label>
										<select required id="productAreaInput" class="form-control" data-bind="options: productAreas,
																							optionsText: 'name',
																							optionsValue: 'id',
																							value: newProductAreaId,
																							optionsCaption: 'Select a Product Area'">
										</select>
									</div>
									<div class="form-group ml-2 mr-2">
										<label for="titleInput">Title</label>
										<input required type="text" maxlength="25" class="form-control" id="titleInput" data-bind="value: newTitle" placeholder="Enter title">
									</div>
									<div class="form-group ml-2 mr-2">
										<label for="descriptionInput">Description</label>
										<textarea required maxlength="100" class="form-control" id="descriptionInput" rows="3" data-bind="value: newDescription"></textarea>
									</div>									
									<div class="form-group ml-2 mr-2">
										<label for="targetDateInput">Target Date</label>
										<input required type="date" class="form-control" id="targetDateInput" data-bind="value: newTargetDate">									
									</div>
									<div class="form-group ml-2 mr-2">
										<label for="priorityInput">Priority</label>
										<input required type="number" min="0" class="form-control" id="priorityInput" data-bind="value: newPriority" placeholder="0 for highest">									
									</div>
									<div class="form-group ml-2 mr-2">
										<button type="submit" class="btn btn-success">Submit</button>							
									</div>									
								</form>
							</div>
						</div>

					</div>
				</div>
			</div>
		</div>
	</div>
	<div class="row">
		<div class="card-deck mb-3">
			<ul data-bind="foreach: featureRequests" style="list-style-type: none; text-align: left">			
				<!-- The existing feature requests. -->
				<li style="display: inline-block">					
					<div class="card mb-4 box-shadow">
						<div class="card-header">
							<h4 class="my-0 font-weight-normal"><span data-bind='text: title'></span></h4>
						</div>
						<div class="card-body">
							<div>
								<p>Description: <span data-bind='text: description'></span>
								<p>Priority: <span data-bind='text: priority'></span>
								<p>Target: <span data-bind='text: target'></span>
								<p>Product Area: <span data-bind='text: $parent.getProductAreaName(productAreaId())'></span>
								<div> 
									<!-- <button type="button" class="btn btn-outline-warning">Edit</button> -->
									<button type="button" data-bind="click: $parent.deleteFeatureRequest" class="btn btn-outline-danger">Delete</button>	
								</div>							
							</div>
							<!-- <button type="button" data-toggle="collapse" data-target="#demo" class="btn btn-outline-info">More/Less</button> -->
						</div>
					</div>	
				</li>
			</ul>
		</div>	
	</div>
	
  
	
</div>

</body>
</html>
<script type='text/javascript'>
	var FeatureRequestViewModel = function() {
		var self = this;
		
		self.newTitle = ko.observable();
		self.newDescription = ko.observable();
		self.newClientId =ko.observable();
		self.newProductAreaId = ko.observable();
		self.newTargetDate = ko.observable();
		self.newPriority = ko.observable();
		
		self.clientIdSelected = ko.observable();		
		self.productAreaIdSelected = ko.observable();		
				
		self.featureRequests = ko.observableArray([]);
		self.clients = ko.observableArray([]);
		self.productAreas = ko.observableArray([]);
		self.productAreasMap = new Map();
		
		self.lastClientId = 0;
		self.lastProductAreaId = 0;
		
		self.addFeatureRequest = function(data) {
			self.featureRequests.push(new FeatureRequest(data));
		};
		
		self.removeFeatureRequest = function(data) {
			self.featureRequests.remove(data);
		};
		
		self.addClient = function(data) {
			self.clients.push(new Client(data));
		};
		
		self.addProductArea = function(data) {
			self.productAreas.push(new ProductArea(data));
		};
		
		self.getProductAreaName = function(id) {
			return self.productAreasMap.get(id);
		}
		
		self.submitNewFeatureRequest = function() {
			newFeatureRequestModel = {
				"id": 0,
				"title": self.newTitle(),
				"description": self.newDescription(),
				"client_id": self.newClientId(),
				"priority": self.newPriority(),
				"target": self.newTargetDate(),
				"product_area_id": self.newProductAreaId()
			}			
			
			self.submitNewFeatureRequestService(newFeatureRequestModel);
		};
		
		self.deleteFeatureRequest = function() {
			<!-- self.removeFeatureRequest(this); -->
			self.deleteFeatureRequestService(this);
		}
		
		self.getClientFeatureRequests = function() {
			self.lastClientId = this.clientIdSelected();
			self.lastProductAreaId = this.productAreaIdSelected();
			
			self.getClientFeatureRequestsService(this.clientIdSelected(), this.productAreaIdSelected());
		};
		
		self.getClientFeatureRequestsService = function(clientId, productAreaId) {
			self.featureRequests.removeAll();
			urlString = "http://localhost:5000/feature-request/GET?";
			
			if(clientId) {
				urlString += "clientId=" + clientId + "&";
			}
			
			if(productAreaId) {
				urlString += "productAreaId=" + productAreaId;
			}		
			
			$.ajax({
				type: "GET",
				contentType: "application/json; charset=utf-8",
				dataType: "jsonp",
				url: encodeURI(urlString),
				crossDomain: true,
				success: function(data) {
					$.each(data, function(k, v) {
						self.addFeatureRequest(v);
					});
				},
				error: function(data) {
					alertError();
				}
			});			
		};
		
		self.submitNewFeatureRequestService = function(newFeatureRequest) {
			urlString = "http://localhost:5000/feature-request/POST?";
			
			if(newFeatureRequest.title) {
				urlString += "title=" + newFeatureRequest.title + "&";
			}
			
			if(newFeatureRequest.description) {
				urlString += "description=" + newFeatureRequest.description + "&";
			}
			
			if(newFeatureRequest.target) {
				urlString += "target=" + newFeatureRequest.target + "&";
			}
			
			if(newFeatureRequest.priority) {
				urlString += "priority=" + newFeatureRequest.priority + "&";
			}
			
			if(newFeatureRequest.client_id) {
				urlString += "clientId=" + newFeatureRequest.client_id + "&";
			}
			
			if(newFeatureRequest.product_area_id) {
				urlString += "productAreaId=" + newFeatureRequest.product_area_id;
			}		
			
			$.ajax({
				type: "GET",
				contentType: "application/json; charset=utf-8",
				dataType: "jsonp",
				url: encodeURI(urlString),
				crossDomain: true,
				success: function(data) {
					document.getElementById("submitForm").reset();
					$('#submitBlock').collapse('toggle')
					alertSuccess();

					if(self.lastClientId === newFeatureRequest.client_id && 
						(self.lastProductAreaId == null || self.lastProductAreaId === newFeatureRequest.product_area_id)) {
						self.getClientFeatureRequestsService(self.lastClientId, self.lastProductAreaId);;
					}	
				},
				error: function(data) {
					alertError();
				}
			});			
		};
		
		self.deleteFeatureRequestService = function(featureRequest) {

			urlString = "http://localhost:5000/feature-request/DELETE?";			
			
			if(featureRequest.id()) {
				urlString += "id=" + featureRequest.id();
			}		
			
			$.ajax({
				type: "GET",
				contentType: "application/json; charset=utf-8",
				dataType: "jsonp",
				url: encodeURI(urlString),
				crossDomain: true,
				success: function(data) {
					alertSuccess();
					self.removeFeatureRequest(featureRequest);
				},
				error: function(data) {
					alertError();
				}
			});			
		};
		
		self.getClients = function(clientId) {
			self.clients.removeAll();
			urlString = "http://localhost:5000/client/GET";
			
			if(clientId) {
				urlString += "?id=" + clientId;
			}
			
			$.ajax({
				type: "GET",
				contentType: "application/json; charset=utf-8",
				dataType: "jsonp",
				url: encodeURI(urlString),
				crossDomain: true,
				success: function(data) {
					$.each(data, function(k, v) {
						self.addClient(v);
					});
				},
				error: function(data) {
					alertError();
				}
			});			
		};		
		
		self.getProductAreas = function(productAreaId) {
			self.productAreas.removeAll();
			urlString = "http://localhost:5000/product-area/GET";
			
			if(productAreaId) {
				urlString += "?id=" + productAreaId;
			}
			
			$.ajax({
				type: "GET",
				contentType: "application/json; charset=utf-8",
				dataType: "jsonp",
				url: encodeURI(urlString),
				crossDomain: true,
				success: function(data) {
					$.each(data, function(k, v) {
						self.addProductArea(v);		
						self.productAreasMap.set(v.id, v.name);
					});				
				},
				error: function(data) {
					alertError();
				}
			});			
		};	
		
		self.getClients();
		self.getProductAreas();
	};

	function FeatureRequest(data) {
		this.id = ko.observable(data.id);
		this.title = ko.observable(data.title);
		this.description = ko.observable(data.description);
		this.clientId = ko.observable(data.client_id);
		this.priority = ko.observable(data.priority);
		this.target = ko.observable(data.target);
		this.productAreaId = ko.observable(data.product_area_id);
	};
	
	function Client(data) {
		this.id = ko.observable(data.id);
		this.name = ko.observable(data.name);
	};
	
	function ProductArea(data) {
		this.id = ko.observable(data.id);
		this.name = ko.observable(data.name);
	};

	ko.applyBindings(new FeatureRequestViewModel());
	
	function setTargetDateBounds() {
		var today = new Date();
		var dd = today.getDate();
		var mm = today.getMonth() + 1; 
		var yyyy = today.getFullYear();
		if(dd < 10){
			dd = '0' + dd
		} 
		if(mm < 10){
			mm = '0' + mm
		} 

		today = yyyy + '-' + mm + '-' + dd;
		document.getElementById("targetDateInput").setAttribute("min", today);
		fiveYearsFromToday = (yyyy + 5) + '-' + mm + '-' + dd;
		document.getElementById("targetDateInput").setAttribute("max", fiveYearsFromToday);
	}
	
	setTargetDateBounds();
	
	$(document).ready (function(){
            $("#success-alert").hide();
			$("#danger-alert").hide();
	});
	
	function alertSuccess() {
		$("#success-alert").fadeTo(2000, 500).slideUp(500, function(){
			$("#success-alert").slideUp(500);
		});   	
	}
	
	function alertError() {
		$("#danger-alert").fadeTo(2000, 500).slideUp(500, function(){
			$("#edanger-alert").slideUp(500);
		});  
	}
</script>